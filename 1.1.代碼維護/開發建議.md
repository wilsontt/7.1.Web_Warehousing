# 1.1.代碼維護 開發建議

**建立日期**: 2025/11/15  
**狀態**: 建議方案

## 問題分析

### 當前狀況
- ✅ 前端 UI 框架已完成（A/B Layout、共用元件）
- ✅ 規格文件已定義（SPEC v1.2）
- ✅ 開發計畫已制定（PLAN v1.0）
- ❌ 後端 API 尚未建立
- ❌ 資料庫連線未設定
- ❌ 前端無法取得真實資料

### 核心挑戰
代碼維護功能需要與後端資料庫連線，否則無法顯示代碼內容。需要前後端協作開發。

---

## 建議方案：契約驅動開發 (Contract-Driven Development)

### 方案概述
採用「**先定義契約，再並行開發**」的策略，確保前後端可以獨立開發，最後無縫整合。

### 開發流程

```
Phase 1: API 契約定義 (1-2 天)
    ↓
Phase 2: Mock API 實作 (前端可立即開發) (1 天)
    ↓
Phase 3: 前端開發 (使用 Mock API) (並行)
Phase 3: 後端開發 (根據契約實作) (並行)
    ↓
Phase 4: 整合測試 (1-2 天)
    ↓
Phase 5: 驗收與優化
```

---

## 詳細執行步驟

### Phase 1: API 契約定義

**目標**: 定義清晰的 API 介面契約，讓前後端可以並行開發。

**產出物**:
1. **OpenAPI/Swagger 規格文件** (`docs/api/codes-api.yaml`)
2. **TypeScript 型別定義** (`lib/types/codes.ts`)
3. **API 契約文件** (`docs/api/CODES_API_CONTRACT.md`)

**內容**:
- 定義 3 個 API 端點：
  - `GET /api/codes/tree` - 取得三層分類資料
  - `POST /api/codes/batch` - 批次儲存
  - `GET /api/codes/search` - 查詢功能
- 定義請求/回應格式
- 定義錯誤碼與錯誤訊息格式
- 定義權限要求（RBAC）

**執行者**: 前端 + 後端工程師共同討論

---

### Phase 2: Mock API 實作

**目標**: 建立 Mock API 服務，讓前端可以立即開始開發。

**產出物**:
1. **Mock 資料結構** (`lib/mocks/codesMock.ts`)
2. **Mock API 服務** (`lib/api/codes.ts` - 使用 Mock)
3. **Mock 資料產生器** (產生符合契約的測試資料)

**實作方式**:
```typescript
// lib/api/codes.ts
export async function getCodesTree(): Promise<CodesTreeResponse> {
  // 開發環境：使用 Mock
  if (process.env.NODE_ENV === "development" && !process.env.NEXT_PUBLIC_API_URL) {
    return getMockCodesTree();
  }
  
  // 生產環境：使用真實 API
  const response = await fetch(`${API_BASE_URL}/codes/tree`, {
    headers: { Authorization: `Bearer ${getToken()}` }
  });
  return response.json();
}
```

**優點**:
- 前端可以立即開始開發 UI
- 不需要等待後端完成
- 可以測試各種資料情境（空資料、大量資料、錯誤情況）

---

### Phase 3: 並行開發

#### 3.1 前端開發（使用 Mock API）

**任務**:
1. 建立三欄式連動介面
2. 實作層級篩選邏輯
3. 實作批次 CRUD 功能
4. 實作欄位驗證
5. 實作未儲存變更提示
6. 單元測試與整合測試

**優勢**:
- 不依賴後端進度
- 可以完整測試 UI/UX
- 可以驗證前端邏輯正確性

#### 3.2 後端開發（根據契約實作）

**任務**:
1. 建立資料庫連線（Entity Framework Core）
2. 建立 API Controller
3. 實作 RBAC 權限檢查
4. 實作批次儲存交易邏輯
5. 實作稽核日誌
6. 單元測試與整合測試

**優勢**:
- 不依賴前端進度
- 可以專注於業務邏輯
- 可以驗證資料庫操作正確性

---

### Phase 4: 整合測試

**目標**: 將前端與後端整合，驗證完整流程。

**步驟**:
1. 設定環境變數 `NEXT_PUBLIC_API_URL` 指向後端 API
2. 執行端對端測試
3. 驗證 API 契約符合性
4. 效能測試（回應時間 ≤ 1.5 秒）
5. 安全測試（RBAC、稽核日誌）

---

### Phase 5: 驗收與優化

**任務**:
1. 功能驗收（對照 SPEC 驗收條件）
2. 效能優化
3. 錯誤處理完善
4. 文件更新

---

## 具體建議

### 建議 1: 立即開始 Phase 1（API 契約定義）

**理由**:
- 這是前後端協作的基礎
- 可以明確定義介面，避免後續修改
- 符合契約驅動開發最佳實踐

**行動**:
1. 建立 `docs/api/` 目錄
2. 建立 OpenAPI 規格文件
3. 建立 TypeScript 型別定義
4. 與後端工程師確認契約

### 建議 2: 優先建立 Mock API

**理由**:
- 前端可以立即開始開發
- 不阻塞開發進度
- 可以測試各種情境

**行動**:
1. 建立 `lib/mocks/codesMock.ts`
2. 建立 `lib/api/codes.ts`（支援 Mock 與真實 API 切換）
3. 產生符合契約的測試資料

### 建議 3: 遵循 SDD 工作流程

**理由**:
- 確保開發流程規範化
- 符合專案憲章要求
- 可以追蹤進度

**行動**:
1. 建立 `任務清單 (Tasks)-1.1.代碼維護.md`
2. 按照 Phase 1-5 逐步執行
3. 每個階段完成後進行 Review

---

## 風險與緩解

| 風險 | 影響 | 緩解方案 |
|------|------|---------|
| 後端 API 延遲 | 前端無法測試真實資料 | 使用 Mock API，前端可獨立開發 |
| API 契約變更 | 前後端需要重新調整 | 契約定義階段充分討論，變更需雙方同意 |
| 資料庫結構不符 | 無法正確顯示資料 | 參考 `CDF_TABLE.md` 等文件，建立資料對照表 |
| 效能不達標 | 不符合規格要求 | 建立效能測試，後端優化查詢 |

---

## 推薦執行順序

### 立即執行（今天）
1. ✅ 建立 API 契約文件（OpenAPI 規格）
2. ✅ 建立 TypeScript 型別定義
3. ✅ 建立 Mock API 服務

### 本週完成
4. ✅ 建立任務清單（Tasks）
5. ✅ 開始前端 UI 開發（使用 Mock API）
6. ✅ 後端開始 API 開發（根據契約）

### 下週完成
7. ✅ 前端功能完成
8. ✅ 後端 API 完成
9. ✅ 整合測試

---

## 結論

**推薦採用「契約驅動開發 + Mock API」策略**，理由：

1. ✅ **不阻塞開發**: 前端可以立即開始，不等待後端
2. ✅ **降低風險**: 契約定義清楚，減少後續修改
3. ✅ **符合最佳實踐**: 契約驅動開發是業界標準做法
4. ✅ **易於測試**: Mock API 可以測試各種情境
5. ✅ **符合憲章**: 遵循 P4（漸進式交付）和 P3（可測試性）

**下一步行動**: 建議立即開始 Phase 1（API 契約定義），然後建立 Mock API，讓前端可以開始開發。

---

**文件版本**: 1.0  
**建立日期**: 2025/11/15


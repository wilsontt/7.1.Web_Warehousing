# 任務清單 (Tasks): 1.1 代碼維護
**版本**: 1.0  
**狀態**: [進行中]  
**負責人**: [IT 工程師 (您)]  
**依據規格**: `規格文件 (SPEC)-1.1.代碼維護.md` (v1.2)  
**依據計畫**: `開發計畫 (PLAN)-1.1.代碼維護.md` (v1.0)  
**依據憲章**: v2.1.0

## 任務總覽

本文件列出「1.1 代碼維護」模組的所有開發任務，每個任務都對應到規格文件中的驗收條件，並可追溯至開發計畫的工作項目。

**總任務數**: 待定（依 Phase 完成後更新）

---

## Phase 1: API 契約與型別定義 ✅

### T1.1 建立 API 契約文件 ✅
**對應規格**: 4. API 與資料流程  
**對應計畫**: API 優先策略  
**狀態**: 已完成

- [x] 建立 `docs/api/CODES_API_CONTRACT.md` - 人類可讀的 API 規格
- [x] 建立 `docs/api/codes-api.yaml` - OpenAPI 3.0.3 規格
- [x] 定義 3 個 API 端點：GET /api/codes/tree, POST /api/codes/batch, GET /api/codes/search
- [x] 定義請求/回應格式、錯誤碼、業務規則

**驗收條件**: 
- [x] 符合規格 4. API 與資料流程
- [x] 符合憲章 P3 可測試性

---

### T1.2 建立 TypeScript 型別定義 ✅
**對應規格**: 3.4 欄位驗證與對照、6. 相依與資料規格  
**對應計畫**: 資料模型設計  
**狀態**: 已完成

- [x] 建立 `lib/types/codes.ts` - 代碼維護專用型別
- [x] 定義 `MajorCategory`, `MidCategory`, `SubCategory` 介面
- [x] 定義 API 請求/回應型別：`CodesTreeResponse`, `BatchSaveRequest`, `BatchSaveResponse`, `SearchCodesRequest`, `SearchCodesResponse`
- [x] 使用共用型別：`BaseEntity`, `PaginatedResponse`, `BatchOperationResponse`, `ApiErrorResponse`
- [x] 欄位對照：DB 欄位 ↔ React 欄位名稱

**驗收條件**: 
- [x] 符合規格 3.4 欄位對照表
- [x] 符合憲章 P12 數據治理

---

## Phase 2: Mock API 服務 ✅

### T2.1 建立 Mock 資料產生器 ✅
**對應規格**: 4. API 與資料流程  
**對應計畫**: 前端優先開發策略  
**狀態**: 已完成

- [x] 建立 `lib/mocks/codesMock.ts` - Mock 資料產生器
- [x] 實作 `getMockCodesTree()` - 模擬取得樹狀結構
- [x] 實作 `mockBatchSaveCodes()` - 模擬批次儲存（含驗證與業務規則）
- [x] 實作 `mockSearchCodes()` - 模擬查詢（支援關鍵字與分頁）
- [x] 初始化測試資料（3 個大分類、4 個中分類、4 個細分類）
- [x] 實作驗證邏輯（必填欄位、唯一性檢查）
- [x] 實作業務規則（刪除時檢查子項、樂觀鎖定）

**驗收條件**: 
- [x] 符合規格 4. API 與資料流程
- [x] 符合憲章 P3 可測試性

---

### T2.2 建立 API 服務 ✅
**對應規格**: 4. API 與資料流程  
**對應計畫**: API 優先策略  
**狀態**: 已完成

- [x] 建立 `lib/api/codes.ts` - API 服務
- [x] 實作 `getCodesTree()` - 取得三層分類樹狀結構
- [x] 實作 `batchSaveCodes()` - 批次儲存代碼資料
- [x] 實作 `searchCodes()` - 查詢代碼資料
- [x] 支援 Mock 模式（開發環境，當 `NEXT_PUBLIC_API_URL` 未設定時）
- [x] 支援真實 API 模式（生產環境或已設定 API URL）
- [x] 統一的錯誤處理（`CodesApiError`）
- [x] 自動加入認證 Token

**驗收條件**: 
- [x] 符合規格 4. API 與資料流程
- [x] 符合憲章 P2 設計即安全

---

## Phase 3: UI 佈局與框架

### T3.1 建立代碼維護頁面框架 ✅
**對應規格**: 3.1 UI 佈局 – 三欄式連動介面  
**對應計畫**: UI 框架與導覽  
**狀態**: 已完成

- [x] 建立 `app/codes/page.tsx` - 代碼維護主頁面
- [x] 建立 `app/codes/layout.tsx` - 代碼維護頁面 Layout（包含權限檢查）
- [x] 建立 `components/layouts/ThreeColumnLayout.tsx` - 三欄式佈局元件
- [x] 建立 `components/auth/PermissionGuard.tsx` - 權限保護元件
- [x] 使用 A/B Layout 框架（B 區為主內容）
- [x] 實作三欄式佈局（B1/B2/B3，預設 22% / 39% / 39%）
- [x] 支援拖曳調整寬度（範圍 18%–35%）
- [x] 整合深色模式支援
- [x] 建立路由保護（權限檢查：代碼維護權限 `basic-operations`）

**驗收條件**: 
- [x] 符合規格 3.1 驗收條件：A/B 框架、B1/B2/B3 三欄、可拖曳調整
- [x] 符合憲章 P8 UX 一致性

---

### T3.2 建立工具列元件 ✅
**對應規格**: 3.1 UI 佈局 – 三欄式連動介面（B2-1 工具列）  
**對應計畫**: 共用元件  
**狀態**: 已完成

- [x] 建立 `components/codes/CodesToolbar.tsx` - 代碼維護工具列
- [x] 實作按鈕：新增大分類 / 新增中分類 / 新增細分類 / 刪除 / 查詢 / 列印 / 儲存 / 取消
- [x] 按鈕狀態管理（依資料狀態動態啟用/禁用）
  - [x] 新增大分類：禁止在已有未儲存列時重複新增
  - [x] 新增中分類：必須先選取大分類，且禁止重複新增
  - [x] 新增細分類：必須先選取中分類，且禁止重複新增
  - [x] 刪除：必須先選取列
  - [x] 儲存/取消：沒有未儲存變更時禁用
- [x] 未儲存變更時，「儲存」、「取消」需高亮（使用 primary variant）
- [x] 顯示「有未儲存變更」提示（黃色警告框）
- [x] 整合 `Toolbar` 共用元件
- [x] 整合至 `app/codes/page.tsx`（B2-1 工具列位置）

**驗收條件**: 
- [x] 符合規格 3.1 驗收條件：B2-1 工具列按鈕、未儲存變更提示
- [x] 符合憲章 P8.3 明確的儲存機制

---

## Phase 4: 三欄式列表元件

### T4.1 建立大分類列表元件 ✅
**對應規格**: 3.1 UI 佈局 – 三欄式連動介面（B1 欄）  
**對應計畫**: 資料列表元件  
**狀態**: 已完成

- [x] 建立 `components/codes/MajorCategoryList.tsx` - 大分類列表
- [x] 使用 `DataTable` 共用元件
- [x] 顯示欄位：大分類編碼 (majorCatNo)、大分類名稱 (majorCatName)
- [x] 實作隔行變色、選取高亮、欄位內容不折行、固定表頭、水平捲軸（由 DataTable 提供）
- [x] 實作點選事件（觸發中分類篩選）
- [x] 標示目前選取的大分類（使用 selectedRowIndex）
- [x] 整合至主頁面，載入資料並實作連動邏輯

**驗收條件**: 
- [x] 符合規格 3.1 驗收條件：列表樣式、選取高亮
- [x] 符合規格 3.2 驗收條件：點選後觸發中分類篩選
- [x] 符合憲章 P8 UX 一致性

---

### T4.2 建立中分類列表元件 ✅
**對應規格**: 3.1 UI 佈局 – 三欄式連動介面（B2 欄）  
**對應計畫**: 資料列表元件  
**狀態**: 已完成

- [x] 建立 `components/codes/MidCategoryList.tsx` - 中分類列表
- [x] 使用 `DataTable` 共用元件
- [x] 顯示欄位：中分類編碼 (midCatCode)、編碼說明 (codeDesc)、數值1 (value1)、數值2 (value2)、備註 (remark)
- [x] 實作隔行變色、選取高亮、欄位內容不折行、固定表頭、水平捲軸（由 DataTable 提供）
- [x] 實作點選事件（觸發細分類篩選）
- [x] 標示目前選取的中分類（使用 selectedRowIndex）
- [x] 根據選取的大分類自動篩選（只顯示相同 majorCatNo）
- [x] 未選取大分類時，顯示提示訊息
- [x] 整合至主頁面，實作篩選邏輯

**驗收條件**: 
- [x] 符合規格 3.1 驗收條件：列表樣式、選取高亮
- [x] 符合規格 3.2 驗收條件：點選後觸發細分類篩選、依大分類篩選
- [x] 符合憲章 P8 UX 一致性

---

### T4.3 建立細分類列表元件 ✅
**對應規格**: 3.1 UI 佈局 – 三欄式連動介面（B3 欄）  
**對應計畫**: 資料列表元件  
**狀態**: 已完成

- [x] 建立 `components/codes/SubCategoryList.tsx` - 細分類列表
- [x] 使用 `DataTable` 共用元件
- [x] 顯示欄位：細分類編碼 (subcatCode)、編碼說明 (codeDesc)、備註 (remark)
- [x] 實作隔行變色、選取高亮、欄位內容不折行、固定表頭、水平捲軸（由 DataTable 提供）
- [x] 根據選取的大分類與中分類自動篩選（只顯示同時符合 majorCatNo 與 midCatCode）
- [x] 未選取中分類時，顯示提示訊息
- [x] 整合至主頁面，實作篩選邏輯

**驗收條件**: 
- [x] 符合規格 3.1 驗收條件：列表樣式、選取高亮
- [x] 符合規格 3.2 驗收條件：依大分類與中分類篩選
- [x] 符合憲章 P8 UX 一致性

---

## Phase 5: 連動邏輯與狀態管理

### T5.1 實作層級篩選邏輯 ✅
**對應規格**: 3.2 連動邏輯 – 層級篩選  
**對應計畫**: 狀態管理  
**狀態**: 已完成

- [x] 建立狀態管理（使用 React useState，符合簡潔優先原則）
- [x] 實作大分類選取 → 中分類篩選邏輯（使用 useMemo）
- [x] 實作中分類選取 → 細分類篩選邏輯（使用 useMemo）
- [x] 實作切換分類時的未儲存變更檢查
- [x] 建立 `components/common/ConfirmDialog.tsx` - 確認對話框元件
- [x] 實作確認對話框：「您有未儲存的變更，是否要放棄？」
- [x] 確認後才允許切換分類
- [x] 清除未選取層級的下層資料（例如：切換大分類時，清空細分類）
- [x] 避免重複選取同一個分類

**驗收條件**: 
- [x] 符合規格 3.2 驗收條件：層級篩選、未儲存變更提示
- [x] 符合憲章 P8.3 明確的儲存機制

---

## 之後內容略（同原檔完整內容）

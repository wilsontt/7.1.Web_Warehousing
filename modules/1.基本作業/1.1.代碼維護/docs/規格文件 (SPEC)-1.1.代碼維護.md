# 規格文件 (SPEC): 1. 基本作業 - 代碼維護
**版本**: 1.2 (草稿)  
**狀態**: [草稿]  
**負責人**: [IT 工程師 (您)]  
**依據憲章**: v2.1.0

## 1. 模組概述 (Overview)
本模組提供「代碼維護 (WD00000)」之 Web 版改寫，採三欄式連動介面管理「大分類 (CDF)」、「中分類 (CDS)」、「細分類 (CDT)」資料。  
所有資料異動 (新增、修改、刪除) 需透過明確的「儲存」動作批次提交，符合憲章 P8.3。

## 2. 範圍與角色 (Scope & Roles)
- **納入**：大 / 中 / 細分類維護、批次儲存、欄位驗證、操作稽核、權限控管、資料欄位對照 (DB ↔ React)。
- **排除**：其他代碼檔及報表輸出。
- **主要角色**：系統管理員、系統維護人員 (需具備代碼維護權限)。

## 3. 使用者故事與驗收條件 (Features & User Stories)

### 3.1 UI 佈局 – 三欄式連動介面
**使用者故事**  
- **身為** 系統管理員  
- **我想要** 在同一畫面依序檢視並維護大/中/細分類  
- **以便** 快速掌握層級關係

**驗收條件** – [憲章 P3, P8]  
- [ ] 介面採 A/B 框架：B 區為主內容，分為 B1/B2/B3 三欄 (預設 22% / 39% / 39%，可拖曳調整，範圍 18%–35%)。  
- [ ] B2-1 工具列按鈕：新增大分類 / 新增中分類 / 新增細分類 / 刪除 / 查詢 / 列印 / 儲存 / 取消。  
- [ ] 列表需符合隔行變色、選取高亮、欄位內容不折行、固定表頭與必要的水平捲軸。  
- [ ] 有未儲存變更時，「儲存」、「取消」需高亮，並顯示「有未儲存變更」提示。

### 3.2 連動邏輯 – 層級篩選
**使用者故事**  
- **身為** 系統管理員  
- **我想要** 依據選取的大分類自動縮小中/細分類範圍  
- **以便** 確保維護上下層關聯

**驗收條件** – [憲章 P3]  
- [ ] 點選大分類 (majorCatNo) 後，中分類 (`midCatList`) 只顯示相同 `majorCatNo`，細分類清空並顯示提示。  
- [ ] 點選中分類 (midCatCode) 後，細分類 (`subCatList`) 只顯示同時符合 `majorCatNo` 與 `midCatCode` 的資料。  
- [ ] 目前被選取的大／中分類需明確標示。  
- [ ] 若存在未儲存變更而欲切換分類，需先顯示確認對話框：「您有未儲存的變更，是否要放棄？」；確認後才允許切換。

### 3.3 資料維護 – 批次 CRUD
**使用者故事**  
- **身為** 系統管理員  
- **我想要** 在各分類列表中進行新增、修改、刪除，最後一次性儲存  
- **以便** 降低誤操作並保持資料一致

**驗收條件** – [憲章 P2, P3, P8.3]  
- [ ] 新增大分類：前端插入空白列並標記 `pendingCreate`；禁止在已有未儲存列時重複新增。  
- [ ] 新增中/細分類前必須先選取上層分類，系統自動帶入對應 `majorCatNo`、`midCatCode`。  
- [ ] 列表支援儲存格內編輯，修改列標記 `pendingUpdate`。  
- [ ] 鍵值欄位 (`majorCatNo`, `midCatCode`, `subcatCode`) 建立後不可修改。  
- [ ] 刪除需二次確認，刪除列標記 `pendingDelete` (以刪除線或醒目色顯示)。  
- [ ] 按「儲存」時，前端組合批次請求 (新增 / 修改 / 刪除陣列) 送往後端，後端需於單一交易內處理。  
- [ ] 儲存成功後重新載入最新資料並清除 `pending` 狀態；失敗時顯示錯誤訊息並保留編輯狀態。  
- [ ] 按「取消」時需二次確認，若確認即放棄所有變更並重新讀取後端資料。  
- [ ] 後端禁止刪除仍存在子分類的資料；違反時回傳明確錯誤。  
- [ ] 所有操作需寫入稽核日誌 (操作人員、時間、IP、操作類型、分類鍵值)。

### 3.4 欄位驗證與對照
**使用者故事**  
- **身為** 系統管理員  
- **我想要** 清楚掌握欄位限制與前後端命名  
- **以便** 依規範快速檢核資料

**驗收條件** – [憲章 P3, P5]  
- [ ] 必填欄位：`majorCatNo`, `majorCatName`, `midCatCode`, `codeDesc`, `subcatCode`。  
- [ ] 代號欄位須符合長度限制 (`majorCatNo`/`midCatCode`/`subcatCode` = 3)；說明欄位遵守資料表最大長度。  
- [ ] 前端錯誤訊息使用正體中文，文案參考 `standards/2.文件倉儲管理系統 Warehouse Management System 設計規範v2.0.md`。  
- [ ] React 欄位名稱不得直接使用資料庫欄位代號，需使用下表對照。

| DB 欄位 | 中文欄名 | React 欄名 |
| --- | --- | --- |
| CDF00 | 大分類編碼 | `majorCatNo` |
| CDF01 | 大分類名稱 | `majorCatName` |
| CDS00 | 中分類編碼 | `midCatCode` |
| CDS01 | 編碼說明 | `codeDesc` |
| CDS02 / CDS03 | 數值1 / 數值2 | `value1` / `value2` |
| CDS04 | 備註 | `remark` |
| CDT00 | 細分類編碼 | `subcatCode` |
| CDT01 | 編碼說明 | `codeDesc` |
| CDT02 | 備註 | `remark` |
| CRE_USERID / CRE_DTIME / UPD_USERID / UPD_DTIME | 建檔/修改資訊 | `createdBy`, `createdDate`, `modifiedBy`, `modifiedDate` |
| id / cdf_id / cds_id | 序號 | `majorCatId`, `midCatId`, `subCatId` |
| lock_version | 鎖定版本 | `lockVer` |
| created_at / updated_at | 建立/更新時間 | `createdTime`, `updatedTime` |

### 3.5 查詢與列印
**使用者故事**  
- **身為** 系統管理員  
- **我想要** 快速查詢指定代號或說明，並產出列印格式  
- **以便** 溝通與稽核

**驗收條件** – [憲章 P3, P7]  
- [ ] 查詢提供關鍵字 (含代號/名稱/說明) 及篩選條件 (大分類代號)。  
- [ ] 查詢結果需高亮符合條件的列並保留上下文。  
- [ ] 列印輸出三欄層級表格，附列印日期、操作者及目前篩選條件。

## 4. API 與資料流程 (API & Data Flow)
- `GET /api/codes/tree`: 取得三層分類資料，後端依角色權限回傳可讀範圍。  
- `POST /api/codes/batch`: 以批次 payload `{ creates:[], updates:[], deletes:[] }` 送出異動；後端需驗證欄位、檢查唯一性、確保刪除時無子項並在單一交易中執行。  
- `GET /api/codes/search`: 查詢 API。  
- 所有 API 需實作 RBAC 與稽核日誌 [憲章 P2]，並回傳一致的錯誤格式。

## 5. 非功能性需求 (Non-Functional Requirements)
- **效能** [憲章 P9]：  
  - `GET /api/codes/tree` 回應時間 ≤ 1.5 秒 (測試基準：1000 筆大分類及其子項)。  
  - 批次儲存操作 ≤ 2 秒完成並回傳結果。  
- **安全** [憲章 P2]：  
  - 僅具備「代碼維護」權限者可操作。  
  - 所有 CUD 行為須寫入稽核日誌 (含異動前後差異)。  
- **語系** [憲章 P5]：UI、錯誤訊息、列印報表皆使用正體中文。  
- **可用性**：  
  - 未儲存提示需涵蓋關閉頁籤、瀏覽器刷新 (beforeunload)。  
  - 支援鍵盤操作：Tab / Shift+Tab 移動儲存格，Enter 進入編輯。  
- **可觀測性** [憲章 P13]：  
  - 前端紀錄主要操作事件 (操作類型、分類代號)。  
  - 後端提供批次儲存追蹤 ID，便於稽核。

## 6. 相依與資料規格 (Dependencies & Data Contracts)
- 資料表：`CDF`, `CDS`, `CDT` (沿用既有結構)。  
- 欄位資料型態參考 `CDF_TABLE.md`、`CDS_TABLE.md`、`CDT_TABLE.md`。  
- 前端型別定義需同步上述 React 欄位命名。

## 7. 測試計畫摘錄 (Testing Notes)
- 單元測試：  
  - 連動篩選 (大 → 中 → 細)。  
  - 未儲存變更提示。  
  - 欄位驗證 (必填 / 長度 / 唯一)。  
  - 批次儲存成功與失敗。  
- 整合測試：  
  - 批次儲存 API 交易 rollback 驗證。  
  - 權限阻擋 (未授權使用者)。

## 8. 模組依賴性 (Dependencies)
- 需依賴「系統管理作業」模組提供使用者角色/權限設定。  
- 需依賴「系統操作紀錄」模組紀錄稽核資料。  
- UI 設定需符合 `DESIGN_GUIDELINES.md` 與 `DataTableConfig`。

## 9. 憲章遵循檢查 (Constitution Check)
- **P1**：介面與 API 採一致布局與批次操作，維持簡潔。  
- **P2**：實作 RBAC、稽核日誌、交易保護。  
- **P3**：所有故事具明確驗收條件，可驗證。  
- **P4**：模組功能可分階段交付 (UI、CRUD、稽核)。  
- **P5**：所有產出強制使用正體中文。  
- **P7**：列出測試重點與交易回滾要求。  
- **P8**：遵循 A/B 框架與批次儲存規範。  
- **P9**：明確定義 API 效能門檻。  
- **P10–P13**：遵循 DDD、欄位命名與可觀測性要求。  
- **H1–H3**：版本標記 1.2，後續核可後更新狀態。

### 2025/11/16 規格補充
- 列表互動：列 hover 顯著（主色淡化背景 + ring-2），選取與 hover 可共存且不影響可讀性。
- 分頁資訊模式：支援 `full | compact | auto`；B1（大分類）因寬度較小優先採用 `compact` 或 `auto`。
- 深/淺色一致性：A 區導覽列、三欄列表、Dialog、分頁列均需具 `dark:` 對應樣式，對比度達 AA。



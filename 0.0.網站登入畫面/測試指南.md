# 登入功能測試指南

## 目錄

1. [自動化測試（單元測試與整合測試）](#自動化測試)
2. [手動測試步驟](#手動測試步驟)
3. [測試場景說明](#測試場景說明)
4. [常見問題排解](#常見問題排解)

---

## 自動化測試

### 執行所有測試

```bash
npm test
```

### 執行測試並顯示覆蓋率

```bash
npm run test:coverage
```

### 監聽模式（開發時使用）

```bash
npm run test:watch
```

### 測試內容

#### 單元測試（`__tests__/components/LoginForm.test.tsx`）

- ✅ 表單渲染測試
- ✅ 表單驗證測試（必填欄位）
- ✅ 密碼顯示/隱藏切換測試
- ✅ 按鈕禁用/啟用測試
- ✅ Loading 狀態測試
- ✅ 表單重置測試

#### 整合測試（`__tests__/integration/loginFlow.test.tsx`）

- ✅ 登入成功流程測試
- ✅ 登入失敗流程測試
- ✅ 帳號鎖定流程測試

#### 安全測試（`__tests__/security/security.test.ts`）

- ✅ 敏感資訊檢查
- ✅ XSS 防護測試
- ✅ Session Fixation 防護測試

---

## 手動測試步驟

### 前置準備

1. **啟動開發伺服器**
   ```bash
   npm run dev
   ```

2. **確認後端 API 服務**
   - 後端 API 應運行在 `http://localhost:3001/api`（或設定在 `.env.local` 中）
   - 環境變數設定：
     ```env
     NEXT_PUBLIC_API_URL=http://localhost:3001/api
     ```

3. **開啟瀏覽器**
   - 前往 `http://localhost:3000/login`
   - 建議使用 Chrome DevTools 觀察網路請求和 Console 訊息

### 測試場景 1: 正常登入流程

#### 步驟

1. **開啟登入頁面**
   - 訪問 `http://localhost:3000/login`
   - 確認頁面正常顯示：
     - Logo 顯示
     - 標題「文件倉儲管理系統」
     - 帳號和密碼輸入框
     - 登入和取消按鈕

2. **輸入有效帳號密碼**
   - 帳號欄位：輸入正確的帳號
   - 密碼欄位：輸入正確的密碼
   - 確認登入按鈕已啟用（不再是灰色）

3. **點擊登入**
   - 點擊「登入」按鈕
   - 觀察按鈕文字變為「登入中...」
   - 按鈕應被禁用（防止重複提交）

4. **驗證登入結果**
   - **成功情況**：
     - 如果不需要 2FA，應自動導向 `/dashboard`
     - 如果需要 2FA，應導向 `/login/2fa`
   - **失敗情況**：
     - 顯示錯誤訊息：「您輸入的帳號或密碼不正確，請重新輸入。」
     - 顯示錯誤次數（如果後端有回傳）

#### 預期結果

✅ 登入成功後：
- Token 儲存在 localStorage（可在 DevTools → Application → Local Storage 查看 `auth_token`）
- 使用者資訊儲存在 localStorage（`user_info`）
- 頁面導向 Dashboard 或 2FA 頁面

### 測試場景 2: 表單驗證

#### 測試必填驗證

1. **帳號為空**
   - 不輸入帳號，直接點擊登入按鈕
   - 登入按鈕應該被禁用

2. **密碼為空**
   - 只輸入帳號，不輸入密碼
   - 登入按鈕應該被禁用

3. **空白字元**
   - 帳號輸入只有空白字元（例如：`   `）
   - 應該無法通過驗證

4. **錯誤訊息顯示**
   - 輸入帳號後，點擊密碼欄位，再點擊其他區域（觸發 onBlur）
   - 應該顯示驗證錯誤訊息

#### 預期結果

✅ 驗證應在失去焦點（onBlur）時觸發
✅ 錯誤訊息為繁體中文
✅ 錯誤時輸入框應顯示紅色邊框

### 測試場景 3: 密碼顯示/隱藏

#### 步驟

1. **輸入密碼**
   - 在密碼欄位輸入文字（例如：`password123`）
   - 確認預設為隱藏狀態（顯示 `•••`）

2. **切換顯示**
   - 點擊密碼欄位右側的眼睛圖示
   - 確認密碼顯示為明文
   - 再次點擊，確認密碼隱藏

#### 預期結果

✅ 點擊眼睛圖示可以切換顯示/隱藏
✅ 圖示會根據狀態改變（眼睛開/閉）
✅ 可用鍵盤操作（Tab 導覽、Enter 提交）

### 測試場景 4: 登入失敗與錯誤處理

#### 測試錯誤次數累計

1. **輸入錯誤帳號密碼**
   - 帳號：輸入錯誤帳號
   - 密碼：輸入錯誤密碼
   - 點擊登入

2. **觀察錯誤訊息**
   - 應該顯示：「您輸入的帳號或密碼不正確，請重新輸入。」
   - 如果後端回傳錯誤次數，應該顯示（例如：「錯誤次數：3 次」）

3. **連續錯誤測試**
   - 重複步驟 1-2，累計錯誤次數
   - 觀察錯誤次數是否正確累計

#### 預期結果

✅ 錯誤訊息統一，不透露帳號是否存在
✅ 錯誤次數正確顯示（如果後端有回傳）
✅ 錯誤訊息區域為黃色警告樣式

### 測試場景 5: 帳號鎖定

#### 步驟

1. **觸發帳號鎖定**
   - 連續輸入錯誤 6 次（或模擬後端回傳 `isLocked: true`）

2. **驗證鎖定狀態**
   - 應該顯示鎖定訊息：「您已連續輸入錯誤達 6 次，帳號已被鎖定。請與管理人員聯繫。」
   - 登入表單應該被禁用
   - 登入按鈕應該被禁用（灰色且無法點擊）

#### 預期結果

✅ 鎖定訊息為紅色警告樣式
✅ 表單完全禁用
✅ 無法繼續輸入或提交

### 測試場景 6: 二階段驗證 (2FA)

#### 前置條件

- 後端 API 需支援 2FA
- 登入 API 回應包含 `requires2FA: true`

#### 步驟

1. **觸發 2FA**
   - 使用已啟用 2FA 的帳號登入
   - 登入成功後，應自動導向 `/login/2fa`

2. **選擇驗證方式**
   - 選擇「簡訊」或「電子郵件」
   - 系統應自動發送驗證碼

3. **輸入驗證碼**
   - 在 6 個輸入框中輸入驗證碼
   - 或直接貼上完整的 6 位數驗證碼

4. **驗證成功**
   - 點擊「驗證」按鈕
   - 成功後應導向 Dashboard

5. **驗證碼過期**
   - 等待 5 分鐘（驗證碼有效期限）
   - 或點擊「重新發送驗證碼」（需等待 60 秒）

#### 預期結果

✅ 2FA 頁面正常顯示
✅ 驗證碼有效期限倒數計時器正常運作
✅ 重新發送倒數計時器正常運作（60 秒）
✅ 驗證碼輸入錯誤時顯示錯誤訊息

### 測試場景 7: 自動登出

#### 步驟

1. **登入系統**
   - 成功登入後進入 Dashboard

2. **模擬閒置**
   - 不進行任何操作，等待 29 分鐘

3. **觀察警告**
   - 在 29 分鐘時（剩餘 1 分鐘），應彈出警告視窗
   - 顯示：「您已經 X 分 X 秒沒有操作，系統將在 X 秒後自動登出。」

4. **延長會話**
   - 點擊「延長會話（30 分鐘）」按鈕
   - 計時器應重置，警告視窗消失

5. **立即登出**
   - 再次觸發警告時，點擊「立即登出」
   - 應清除所有認證資料並返回登入頁面

#### 預期結果

✅ 30 分鐘閒置後自動登出
✅ 登出前 1 分鐘顯示警告
✅ 可以延長會話或立即登出
✅ 登出時清除 localStorage 中的認證資料

### 測試場景 8: 深色模式

#### 步驟

1. **切換深色模式**
   - 點擊登入頁面右上角的主題切換按鈕
   - 觀察頁面顏色變化

2. **測試三種模式**
   - **淺色模式**：白色背景
   - **深色模式**：深色背景
   - **系統模式**：跟隨作業系統設定

3. **驗證持久化**
   - 重新整理頁面，確認主題偏好被儲存

#### 預期結果

✅ 主題切換平滑（300ms 過渡動畫）
✅ 主題偏好儲存在 localStorage
✅ 重新整理後主題保持不變

---

## 測試場景說明

### 後端 API Mock（開發測試用）

如果需要測試但後端尚未完成，可以使用以下方式 Mock API：

1. **使用 MSW (Mock Service Worker)**
   ```bash
   npm install --save-dev msw
   ```

2. **建立 Mock Handler**
   ```typescript
   // __mocks__/handlers.ts
   import { rest } from 'msw';

   export const handlers = [
     rest.post('/api/auth/login', (req, res, ctx) => {
       return res(
         ctx.json({
           success: true,
           token: 'mock-token',
           user: { id: '1', username: 'test', name: 'Test User', roles: [], permissions: [] }
         })
       );
     }),
   ];
   ```

### 使用瀏覽器 DevTools 檢查

#### Network 面板

- 檢查 API 請求：
  - `POST /api/auth/login`
  - `POST /api/auth/2fa/send`
  - `POST /api/auth/2fa/verify`
- 確認請求標頭：
  - `Content-Type: application/json`
  - `Authorization: Bearer <token>`（登入後）
  - `X-CSRF-Token: <token>`（如果有）

#### Application 面板

- **Local Storage**：
  - `auth_token`: 登入 Token
  - `refresh_token`: Refresh Token
  - `user_info`: 使用者資訊
  - `theme`: 主題偏好

- **Session Storage**：
  - `csrf_token`: CSRF Token（如果有）

#### Console 面板

- 檢查是否有錯誤訊息
- 檢查稽核日誌記錄（如果實作 Console 記錄）

---

## 常見問題排解

### 問題 1: 登入後沒有導向 Dashboard

**可能原因：**
- 後端 API 回應格式不符預期
- Router 未正確設定

**解決方法：**
1. 檢查 Network 面板中的 API 回應
2. 確認回應包含 `success: true` 和 `token`
3. 檢查 Console 是否有錯誤訊息

### 問題 2: 錯誤訊息沒有顯示

**可能原因：**
- 後端 API 回應格式不符預期
- 錯誤處理邏輯未正確觸發

**解決方法：**
1. 檢查 Network 面板中的錯誤回應
2. 確認錯誤回應包含 `message` 或 `errorCount`
3. 檢查 `AuthError` 類別是否正確處理錯誤

### 問題 3: Token 沒有儲存

**可能原因：**
- localStorage 被禁用
- API 回應不包含 token

**解決方法：**
1. 檢查 DevTools → Application → Local Storage
2. 確認 API 回應包含 `token` 欄位
3. 檢查瀏覽器是否允許 localStorage

### 問題 4: 表單驗證沒有觸發

**可能原因：**
- React Hook Form 設定問題
- Zod Schema 設定問題

**解決方法：**
1. 確認 `mode: "onBlur"` 已設定
2. 檢查輸入框是否正確使用 `register`
3. 確認 Zod Schema 驗證規則正確

### 問題 5: 自動登出沒有觸發

**可能原因：**
- `IdleSessionManager` 未正確載入
- Token 不存在

**解決方法：**
1. 確認已成功登入（有 Token）
2. 檢查 `IdleSessionManager` 是否在 `app/layout.tsx` 中載入
3. 確認不在登入頁面（路徑不是 `/login`）

---

## 測試檢查清單

### 功能測試
- [ ] 正常登入流程
- [ ] 表單驗證（必填、空白字元）
- [ ] 密碼顯示/隱藏切換
- [ ] 登入失敗處理
- [ ] 帳號鎖定處理
- [ ] 2FA 流程（如果有）
- [ ] 自動登出（30 分鐘閒置）
- [ ] 深色模式切換

### 安全測試
- [ ] 密碼不在 localStorage 中儲存
- [ ] Token 正確儲存和清除
- [ ] 錯誤訊息不透露敏感資訊
- [ ] CSRF Token 正確傳送（如果有）
- [ ] Session Fixation 防護（每次登入清除舊認證）

### 效能測試
- [ ] 頁面載入時間
- [ ] API 回應時間（需後端配合）
- [ ] 表單提交響應時間

### 瀏覽器相容性
- [ ] Chrome（最新版）
- [ ] Firefox（最新版）
- [ ] Safari（最新版）
- [ ] Edge（最新版）

---

## 執行測試命令摘要

```bash
# 開發模式
npm run dev

# 執行所有測試
npm test

# 執行測試並顯示覆蓋率
npm run test:coverage

# 監聽模式
npm run test:watch

# 建置生產版本
npm run build

# 執行 Lint
npm run lint
```

---

*最後更新日期：2025/11/15*

